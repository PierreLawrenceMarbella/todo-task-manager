<!DOCTYPE html>
<html>
<head>
  <title>To-Do Task Manager</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    h1 { text-align: center; color: white; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
    h2 { color: #333; margin-bottom: 20px; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: #dc3545; color: white; padding: 8px 16px; font-size: 14px; }
    .btn-success { background: #28a745; color: white; padding: 8px 16px; font-size: 14px; }
    .btn-warning { background: #ffc107; color: #333; padding: 8px 16px; font-size: 14px; }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border: none; background: #e0e0e0; }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab:first-child { border-radius: 8px 0 0 8px; }
    .tab:last-child { border-radius: 0 8px 8px 0; }
    .hidden { display: none; }
    .task-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .task-info { flex: 1; }
    .task-title { font-weight: 600; color: #333; margin-bottom: 5px; }
    .task-priority { font-size: 12px; padding: 4px 12px; border-radius: 20px; display: inline-block; }
    .priority-Low { background: #d4edda; color: #155724; }
    .priority-Medium { background: #fff3cd; color: #856404; }
    .priority-High { background: #f8d7da; color: #721c24; }
    .task-actions { display: flex; gap: 8px; }
    .user-info { text-align: right; color: white; margin-bottom: 10px; }
    .logout-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 16px; }
    .empty-state { text-align: center; color: #6c757d; padding: 40px; }
    .checkbox { width: auto; margin-right: 10px; cursor: pointer; }
    .completed .task-title { text-decoration: line-through; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìù To-Do Task Manager</h1>

    <!-- Auth Section -->
    <div id="authSection" class="card">
      <div class="tabs">
        <button class="tab active" onclick="showTab('login')">Login</button>
        <button class="tab" onclick="showTab('register')">Register</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button class="btn-primary" onclick="login()">Login</button>
      </div>

      <!-- Register Form -->
      <div id="registerForm" class="hidden">
        <input type="text" id="regUsername" placeholder="Username">
        <input type="email" id="regEmail" placeholder="Email">
        <input type="password" id="regPassword" placeholder="Password">
        <button class="btn-primary" onclick="register()">Register</button>
      </div>
    </div>

    <!-- Task Section (Hidden until logged in) -->
    <div id="taskSection" class="hidden">
      <div class="user-info">
        Welcome! <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <!-- Add Task -->
      <div class="card">
        <h2>‚ûï Add New Task</h2>
        <input type="text" id="taskTitle" placeholder="What needs to be done?">
        <select id="taskPriority">
          <option value="Low">üü¢ Low Priority</option>
          <option value="Medium">üü° Medium Priority</option>
          <option value="High">üî¥ High Priority</option>
        </select>
        <button class="btn-primary" onclick="addTask()">Add Task</button>
      </div>

      <!-- Task List -->
      <div class="card">
        <h2>üìã My Tasks</h2>
        <div id="taskList">
          <div class="empty-state">No tasks yet. Add one above!</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let token = localStorage.getItem('token');
    let editingTaskId = null;

    // Check if already logged in
    if (token) {
      showTaskSection();
      loadTasks();
    }

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
      document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
    }

    async function register() {
      const username = document.getElementById('regUsername').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;

      if (!username || !email || !password) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        const data = await res.json();
        
        if (res.ok) {
          alert('Registration successful! Please login.');
          showTab('login');
          document.querySelector('.tab:first-child').click();
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch (error) {
        alert('Error connecting to server');
      }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        
        if (res.ok) {
          token = data.token;
          localStorage.setItem('token', token);
          showTaskSection();
          loadTasks();
        } else {
          alert(data.error || 'Login failed');
        }
      } catch (error) {
        alert('Error connecting to server');
      }
    }

    function logout() {
      token = null;
      localStorage.removeItem('token');
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('taskSection').classList.add('hidden');
    }

    function showTaskSection() {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('taskSection').classList.remove('hidden');
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${API_URL}/tasks`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.status === 401) {
          logout();
          alert('Session expired. Please login again.');
          return;
        }

        const tasks = await res.json();
        renderTasks(tasks);
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }

    function renderTasks(tasks) {
      const taskList = document.getElementById('taskList');
      
      if (tasks.length === 0) {
        taskList.innerHTML = '<div class="empty-state">No tasks yet. Add one above!</div>';
        return;
      }

      taskList.innerHTML = tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}" id="task-${task._id}">
          <div style="display: flex; align-items: center; flex: 1;">
            <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''} 
                   onchange="toggleComplete('${task._id}', this.checked)">
            <div class="task-info">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <span class="task-priority priority-${task.priority}">${task.priority}</span>
            </div>
          </div>
          <div class="task-actions">
            <button class="btn-warning" onclick="editTask('${task._id}', '${escapeHtml(task.title)}', '${task.priority}')">‚úèÔ∏è</button>
            <button class="btn-danger" onclick="deleteTask('${task._id}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function addTask() {
      const title = document.getElementById('taskTitle').value;
      const priority = document.getElementById('taskPriority').value;

      if (!title.trim()) {
        alert('Please enter a task title');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/tasks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, priority })
        });

        if (res.ok) {
          document.getElementById('taskTitle').value = '';
          loadTasks();
        } else {
          alert('Failed to add task');
        }
      } catch (error) {
        alert('Error connecting to server');
      }
    }

    function editTask(id, title, priority) {
      document.getElementById('taskTitle').value = title;
      document.getElementById('taskPriority').value = priority;
      editingTaskId = id;
      
      // Change button to Update
      const addBtn = document.querySelector('#taskSection .btn-primary');
      addBtn.textContent = 'Update Task';
      addBtn.onclick = updateTask;
      
      // Add cancel button
      if (!document.getElementById('cancelBtn')) {
        const cancelBtn = document.createElement('button');
        cancelBtn.id = 'cancelBtn';
        cancelBtn.className = 'btn-secondary';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.marginTop = '10px';
        cancelBtn.style.width = '100%';
        cancelBtn.onclick = cancelEdit;
        addBtn.parentNode.appendChild(cancelBtn);
      }
    }

    function cancelEdit() {
      document.getElementById('taskTitle').value = '';
      editingTaskId = null;
      const addBtn = document.querySelector('#taskSection .btn-primary');
      addBtn.textContent = 'Add Task';
      addBtn.onclick = addTask;
      const cancelBtn = document.getElementById('cancelBtn');
      if (cancelBtn) cancelBtn.remove();
    }

    async function updateTask() {
      const title = document.getElementById('taskTitle').value;
      const priority = document.getElementById('taskPriority').value;

      if (!title.trim()) {
        alert('Please enter a task title');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/tasks/${editingTaskId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, priority })
        });

        if (res.ok) {
          cancelEdit();
          loadTasks();
        } else {
          alert('Failed to update task');
        }
      } catch (error) {
        alert('Error connecting to server');
      }
    }

    async function toggleComplete(id, completed) {
      try {
        await fetch(`${API_URL}/tasks/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ completed })
        });
        loadTasks();
      } catch (error) {
        alert('Error updating task');
      }
    }

    async function deleteTask(id) {
      if (!confirm('Are you sure you want to delete this task?')) return;

      try {
        const res = await fetch(`${API_URL}/tasks/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
          loadTasks();
        } else {
          alert('Failed to delete task');
        }
      } catch (error) {
        alert('Error connecting to server');
      }
    }
  </script>
</body>
</html>
